\chapter{簡易モデルを構成するワイヤーフレームの生成}

\section{ワイヤーフレーム生成の方針}
本研究におけるワイヤーフレーム生成は、屋内環境の床および壁といった空間構造の骨組みを、比較的少数の頂点と線分で表現することを目的とする。
ここで生成されるワイヤーフレームは、後段でテクスチャを付与するための幾何的な基盤であり、
高密度な点群や精密メッシュの再現を目的とするものではない。

本研究において生成される簡易モデルは、複雑な形状を高精度に再現することよりも、
床や壁、通路といった空間の基本的な構成を簡潔に表現することに重点を置く。
これにより、計算コストやデータ管理の負担を抑えつつ，屋内の道案内に必要となる自己位置推定を、
必要十分な精度で実現できる点に特徴がある（図\ref{two:one}）。

\begin{figure}[H]
  \centering
  \begin{tabular}{ccc}
      \includegraphics[width=0.3\linewidth]{figures/2/pointscloud.jpg} &
      \includegraphics[width=0.3\linewidth]{figures/2/3DCG.jpg} &
      \includegraphics[width=0.3\linewidth]{figures/2/model.png} \\
  \end{tabular}
  \caption{異なる3次元モデル表現の比較（左：点群モデル, 中央：フォトグラメトリモデル, 右：本研究で用いる簡易モデル）}
  \label{two:one}
\end{figure}

\subsection{入力情報と前提条件}\label{wire_input}
ワイヤーフレーム生成にあたっては、以下の情報が利用可能であることを前提とする。
\begin{itemize}
  \item{屋内環境を表す2次元マップ}
  \item{2次元マップと3次元座標との4点以上の対応関係}
  \item{屋内環境内でテクスチャを取得したカメラ位置}
\end{itemize}

以下ではこの前提のもと、2次元マップ上で定義された屋内空間の構造情報と、
環境の3次元座標情報との対応関係に基づき、ワイヤーフレームを半自動的に構成する手法について述べる。
ここでいう半自動とは、2次元マップ上での初期境界指定および対応点の入力を人手で行い、それ以降の幾何構造生成を自動化することを指す。

\section{2次元マップと3次元空間の対応付け}

本研究では、2次元マップ上で定義された床境界点を3次元空間の床面上へ写像するために、
2次元座標間の対応関係に基づくアフィン変換を用いる。
床面は水平であると仮定し、床上の3次元座標は常に $Z=0$ に固定されるものとする。
この仮定のもとでは、2次元マップと床面との関係は平行移動・回転・スケーリングによって十分に表現可能であるため、
本研究では射影変換ではなくアフィン変換を採用する。

まず、2次元マップ上の点と、それに対応する床面上の3次元座標を、4点以上与えることができると仮定する。
これらの対応点を用いて、2次元マップ座標系から床面上の2次元座標系へのアフィン変換行列を推定する。
2次元マップ上の点を$\mathbf{p}_i = (x_i, y_i)^\top$、対応する床面上の点を$\mathbf{q}_i = (X_i, Y_i)^\top$とすると、
両者の関係は以下のアフィン変換で表される。

\begin{equation}
\begin{aligned}
\begin{pmatrix}
X_i \\
Y_i
\end{pmatrix}
&=
\mathbf{A}
\begin{pmatrix}
x_i \\
y_i \\
1
\end{pmatrix} \\[1ex]
\mathbf{A}
&=
\begin{pmatrix}
a_{11} & a_{12} & a_{13} \\
a_{21} & a_{22} & a_{23}
\end{pmatrix}
\end{aligned}
\end{equation}

推定されたアフィン変換行列 $\mathbf{A}$ を用いることで、
2次元マップ上の座標を、床面上の3次元座標（$Z=0$）として一意に定めることができる。
4点を超える対応点が与えられる場合には、同一の変換行列を用いて、
すべての床境界点を床面上へ写像する。

最後に、得られた床境界の頂点列が閉ループを形成しているかを確認する。
閉ループになっていない場合には、始点と終点を接続することで多角形になるように修正する。
さらに、頂点列の並び順を判定し、反時計回りとなっている場合には順序を反転させることで、床境界が時計回りとなるように修正する。

\section{床境界におけるカメラ位置に基づくサンプリング}
高品質な床テクスチャを生成するためには詳細な境界点が必要となるが、
これらすべてを手作業で指定することは多大な労力を要するため現実的ではない。 
そこで本研究では、床面ポリゴンの境界上において、カメラ配置を考慮しながら適切な間隔で境界点を自動生成する手法を提案する。
図\ref{two:two}にカメラ位置に基づいて床境界点をサンプリングする方法を示す。

\begin{figure}[H]
  \centering
  \begin{tabular}{c}
    \includegraphics[width=0.8\linewidth]{figures/2/sampling.png}
  \end{tabular}
  \caption{床境界点のサンプリング方法}
  \label{two:two}
\end{figure}

床境界は閉じた多角形として定義され、隣接する2点 $\bf{p}_0$ と $\bf{p}_1$ が1つの境界エッジを構成する。
本手法では、まず各エッジの始点 $\bf{p}_0$ を境界点として採用した上で、カメラ位置に応じた点を追加していく。

具体的には、各カメラ位置 $\bf{c}$ から境界エッジへの正射影を考える。
エッジの方向ベクトル $\bf{d}$ および、始点からの距離比を表す射影係数 $t$ は次式で与えられる。
\begin{equation}
\bf{d} = \bf{p}_1 - \bf{p}_0
\end{equation}
\begin{equation}
t = \frac{(\bf{c} - \bf{p}_0)^\top \bf{d}}{\bf{d}^\top \bf{d}}
\end{equation}

これより、境界直線上への射影点 $\bf{p}_{\mathrm{proj}}$ は次式で表される。
\begin{equation}
\bf{p}_{\mathrm{proj}} = \bf{p}_0 + t \bf{d}
\end{equation}

ここで、射影係数が $t$ が $0 \leq t \leq 1$ （エッジの範囲内）を満たし、かつカメラとの距離が閾値以下である場合、すなわち
\begin{equation}
\lVert \bf{c} - \bf{p}_{\mathrm{proj}} \rVert \leq d_{\mathrm{th}}
\end{equation}
を満たす場合に、その射影点を有効とする。

最後に、得られた有効な射影点に基づき、サンプリング位置（追加の境界点）を決定する。 
テクスチャの歪みを最小限に抑えるには、カメラ正面に近い領域、すなわち射影点付近の形状を重点的に保持することが望ましい。
そこで、同一エッジ上に複数の有効な射影点$\mathbf{p}_{\mathrm{proj1}}, \mathbf{p}_{\mathrm{proj2}}$が存在する場合には、
その点間距離とユーザが定義するサンプリング間隔 $d_{\mathrm{sample}}$ との大小関係に応じて境界点を追加する。
具体的には、射影点間の距離が十分に大きい場合
($\|\mathbf{p}_{\mathrm{proj1}} - \mathbf{p}_{\mathrm{proj2}}\| > d_{\mathrm{sample}}$)には、
各射影点から一定距離だけ内側の位置に境界点を追加する
一方、射影点間の距離が小さい場合
($\|\mathbf{p}_{\mathrm{proj1}} - \mathbf{p}_{\mathrm{proj2}}\| < d_{\mathrm{sample}}$)には、
両者の中点を境界点として追加する。
これにより、カメラ視点に対して最適な密度で床境界点を配置することが可能となる。

最後に、生成された床境界点列全体について隣接点間の距離を確認し、
間隔が大きすぎる部分には中点を追加し、間隔が小さすぎる部分では床境界点を統合する。
この処理により、床境界全体が過度に偏ることなく、おおむね一定のサンプリング間隔で分布するように調整する。

\section{床面および壁面の幾何構造}

床面は、前節までで得られた床境界頂点列 $\{\bf{P}_i\}$ によって囲まれた単純多角形として定義される。
ここで、各床境界頂点は床面上に存在するものとし、その $z$ 座標は $z=0$ に固定されている。

床面に対応する天井境界点列 $\{\bf{P}_i^{\mathrm{ceil}}\}$ は、床境界頂点列の平面形状を保ったまま、
高さ方向に一定量 $H$ だけ平行移動することで生成する。
すなわち、床境界頂点 $\bf{P}_i = (x_i, y_i, 0)$ に対し、
対応する天井境界頂点は $\bf{P}_i^{\mathrm{ceil}} = (x_i, y_i, H)$ として与えられる。

床面の幾何構造は一般に凹形状を含む複雑な多角形となるため、
本研究では、境界形状を保持した制約付き Delaunay 三角形分割を用いて床面を三角形メッシュ化する。
この手法は、Shewchuk によって提案された 2 次元品質メッシュ生成手法として広く用いられている\cite{Shewchuk1996Triangle}。
具体的には、床境界頂点を頂点集合とし、隣接する床境界頂点同士を拘束辺として与えた平面分割問題として定式化する。
このとき、三角形の最大面積を制約条件として与えることで、過度に大きな三角形が生成されることを防ぎ、安定した床面メッシュを得る。

得られた三角形メッシュに対しては、上方（$+z$ 方向）から見たときに、すべての三角形が時計回りとなるように頂点順序を統一する。
これは、後段で行う描画処理や法線計算において、面の向きを一貫させるためである。

壁面の幾何構造は、床境界と天井境界の対応関係に基づいて生成される。
床境界および天井境界は同一の頂点数と順序を持つ閉ループであるため、
対応する隣接頂点対を用いることで壁面を構成できる。
具体的には、床境界の隣接する頂点 $\bf{P}_i, \bf{P}_{i+1}$ と、
それらに対応する天井境界頂点 $\bf{P}_i^{\mathrm{ceil}}, \bf{P}_{i+1}^{\mathrm{ceil}}$ を結ぶことで、
一枚の壁面を表す四角形を定義する。

このようにして生成された床面および壁面の幾何構造は、
本研究における簡易3次元モデルのワイヤーフレーム表現を構成し、
後段で行うテクスチャ付与および自己位置推定処理の基盤として用いられる。
